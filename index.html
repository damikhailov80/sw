<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Service</title>
    <style>
        body {
            visibility: hidden;
        }
        
        body.ready {
            visibility: visible;
        }
        
        #content {
            display: none;
        }
        
        #error {
            color: red;
            text-align: center;
            padding: 20px;
            display: none;
        }
    </style>
    <script>
        // Показываем body когда все стили загружены
        window.addEventListener('load', function() {
            document.body.classList.add('ready');
        });
    </script>
</head>
<body>
    <div id="error"></div>
    
    <div id="content"></div>
    
    <script src="sw-config.js"></script>
    <script src="sw-loader.js"></script>
    <script>
        // Функция загрузки контента
        function loadContent() {
            // Используем специальный URL /hook который будет перехвачен service worker
            const currentPath = window.location.pathname;
            const hookUrl = '/hook' + currentPath;
            console.log('Starting fetch to ' + hookUrl + ' (will be proxied to target server)');
            
            fetch(hookUrl, {
                mode: 'cors',
                credentials: 'omit'
            })
                .then(response => {
                    console.log('Fetch response received:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error('Сервер недоступен (статус: ' + response.status + ')');
                    }
                    return response.text();
                })
                .then(html => {
                    console.log('HTML received, length:', html.length);
                    
                    // Включаем режим перенаправления в service worker
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'ENABLE_REDIRECT'
                        });
                        console.log('Redirect mode enabled in service worker');
                    }
                    
                    // Заменяем все абсолютные URL с localhost:3000 на относительные
                    // чтобы они проходили через service worker
                    let modifiedHtml = html
                        .replace(/http:\/\/localhost:3000\//g, '/')
                        .replace(/https:\/\/localhost:3000\//g, '/')
                        .replace(/\/\/localhost:3000\//g, '/');
                    
                    console.log('Replaced localhost:3000 URLs with relative paths');
                    
                    // Добавляем стиль для скрытия body до загрузки стилей
                    const styleTag = '<style>body{visibility:hidden}</style>';
                    const scriptTag = '<script>window.addEventListener("load",function(){document.body.style.visibility="visible"})<\/script>';
                    
                    // Вставляем стиль и скрипт в начало head
                    if (modifiedHtml.includes('<head>')) {
                        modifiedHtml = modifiedHtml.replace('<head>', '<head>' + styleTag + scriptTag);
                    } else if (modifiedHtml.includes('<html>')) {
                        modifiedHtml = modifiedHtml.replace('<html>', '<html><head>' + styleTag + scriptTag + '</head>');
                    }
                    
                    // Используем document.write для выполнения скриптов
                    document.open();
                    document.write(modifiedHtml);
                    document.close();
                    console.log('Content loaded successfully');
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = 'Ошибка загрузки: ' + error.message + '. Проверьте, что сервер на ' + SW_CONFIG.target.hostname + ':' + SW_CONFIG.target.port + ' запущен и настроен CORS.';
                });
        }
        
        // Перехватываем клики по ссылкам для SPA навигации
        document.addEventListener('click', function(e) {
            // Проверяем, является ли цель ссылкой
            let target = e.target;
            while (target && target.tagName !== 'A') {
                target = target.parentElement;
            }
            
            if (target && target.tagName === 'A' && target.href) {
                const url = new URL(target.href);
                // Если это внутренняя ссылка на наш домен
                if (url.hostname === window.location.hostname && url.port === window.location.port) {
                    e.preventDefault();
                    console.log('Navigating to:', url.pathname);
                    // Используем History API для изменения URL без перезагрузки
                    window.history.pushState({}, '', url.pathname + url.search + url.hash);
                    // Перезагружаем контент для нового пути
                    loadContent();
                }
            }
        }, true);
        
        // Обрабатываем кнопки назад/вперед браузера
        window.addEventListener('popstate', function() {
            console.log('Popstate event, loading content for:', window.location.pathname);
            loadContent();
        });
        
        // Ждем пока service worker будет готов, затем загружаем контент
        if ('serviceWorker' in navigator) {
            console.log('Waiting for Service Worker to be ready...');
            navigator.serviceWorker.ready.then(function(registration) {
                console.log('Service Worker is ready, controller:', navigator.serviceWorker.controller);
                console.log('Service Worker scope:', registration.scope);
                console.log('Service Worker active:', registration.active);
                loadContent();
            });
        } else {
            // Если service worker не поддерживается, загружаем сразу
            console.warn('Service Worker not supported, loading content directly');
            loadContent();
        }
    </script>
</body>
</html>
