<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Service Worker Service</title>
    <style>
        /* body {
            visibility: hidden;
        }
        
        body.ready {
            visibility: visible;
        }
         */
        #content {
            display: none;
        }
        
        #error {
            color: red;
            text-align: center;
            padding: 20px;
            display: none;
        }
    </style>
    <script>
        // Show body when all styles are loaded
        window.addEventListener('load', function() {
            document.body.classList.add('ready');
        });
    </script>
</head>
<body>
    <div id="error"></div>
    
    <div id="content"></div>
    
    <script src="/sw-config.js"></script>
    <script src="/sw-loader.js"></script>
    <script>
        // Content loading function
        function loadContent() {
            // Use special /hook URL that will be intercepted by service worker
            const currentPath = window.location.pathname;
            const hookUrl = '/hook' + currentPath;
            console.log('Starting fetch to ' + hookUrl + ' (will be proxied to target server)');
            
            fetch(hookUrl, {
                mode: 'cors',
                credentials: 'omit'
            })
                .then(response => {
                    console.log('Fetch response received:', response.status, response.statusText);
                    if (!response.ok) {
                        throw new Error('Server unavailable (status: ' + response.status + ')');
                    }
                    return response.text();
                })
                .then(html => {
                    console.log('HTML received, length:', html.length);
                    
                    // Enable redirect mode in service worker
                    if (navigator.serviceWorker.controller) {
                        navigator.serviceWorker.controller.postMessage({
                            type: 'ENABLE_REDIRECT'
                        });
                        console.log('Redirect mode enabled in service worker');
                    }
                    
                    // Replace all absolute URLs with localhost:3000 to relative ones
                    // so they go through the service worker
                    let modifiedHtml = html
                        .replace(/http:\/\/localhost:3000\//g, '/')
                        .replace(/https:\/\/localhost:3000\//g, '/')
                        .replace(/\/\/localhost:3000\//g, '/');
                    
                    console.log('Replaced localhost:3000 URLs with relative paths');
                    
                    // Add style to hide body until styles are loaded
                    const styleTag = '<style>body{visibility:hidden}</style>';
                    const scriptTag = '<script>window.addEventListener("load",function(){document.body.style.visibility="visible"})<\/script>';
                    
                    // Insert style and script at the beginning of head
                    if (modifiedHtml.includes('<head>')) {
                        modifiedHtml = modifiedHtml.replace('<head>', '<head>' + styleTag + scriptTag);
                    } else if (modifiedHtml.includes('<html>')) {
                        modifiedHtml = modifiedHtml.replace('<html>', '<html><head>' + styleTag + scriptTag + '</head>');
                    }
                    
                    // Use document.write to execute scripts
                    document.open();
                    document.write(modifiedHtml);
                    document.close();
                    console.log('Content loaded successfully');
                })
                .catch(error => {
                    console.error('Fetch error:', error);
                    document.getElementById('error').style.display = 'block';
                    document.getElementById('error').textContent = 'Loading error: ' + error.message + '. Check that the server at ' + SW_CONFIG.target.hostname + ':' + SW_CONFIG.target.port + ' is running and CORS is configured.';
                });
        }
        
        // Intercept link clicks for SPA navigation
        document.addEventListener('click', function(e) {
            // Check if the target is a link
            let target = e.target;
            while (target && target.tagName !== 'A') {
                target = target.parentElement;
            }
            
            if (target && target.tagName === 'A' && target.href) {
                const url = new URL(target.href);
                // If this is an internal link to our domain
                if (url.hostname === window.location.hostname && url.port === window.location.port) {
                    e.preventDefault();
                    console.log('Navigating to:', url.pathname);
                    // Use History API to change URL without reload
                    window.history.pushState({}, '', url.pathname + url.search + url.hash);
                    // Reload content for the new path
                    loadContent();
                }
            }
        }, true);
        
        // Handle browser back/forward buttons
        window.addEventListener('popstate', function() {
            console.log('Popstate event, loading content for:', window.location.pathname);
            loadContent();
        });
        
        // Wait for service worker to be ready, then load content
        if ('serviceWorker' in navigator) {
            console.log('Waiting for Service Worker to be ready...');
            navigator.serviceWorker.ready.then(function(registration) {
                console.log('Service Worker is ready, controller:', navigator.serviceWorker.controller);
                console.log('Service Worker scope:', registration.scope);
                console.log('Service Worker active:', registration.active);
                loadContent();
            });
        } else {
            // If service worker is not supported, load immediately
            console.warn('Service Worker not supported, loading content directly');
            loadContent();
        }
    </script>
</body>
</html>
